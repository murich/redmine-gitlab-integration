<fieldset class="box tabular" id="gitlab_integration">
  <legend>GitLab Integration</legend>

  <p>
    <label for="gitlab_group_id">GitLab Group <span class="required">*</span></label>
    <%= select_tag 'gitlab_group_id',
        options_for_select(
          [['-- Select a group or create new --', '']] +
          [['‚ûï Create new group...', 'new']] +
          (@gitlab_groups&.map { |g| [g['name'], g['id']] } || []),
          @selected_group_id
        ),
        id: 'gitlab_group_id',
        required: true %>
    <div id="gitlab_group_notice">
      <% if @inherited_from %>
        <span class="info">üìã Inherited from parent: <%= @inherited_from.name %></span>
      <% end %>
    </div>
  </p>

  <p id="new_group_name_field" style="display: none;">
    <label for="new_group_name">New Group Name</label>
    <%= text_field_tag 'new_group_name', '', placeholder: 'Enter group name (auto-filled from project name)', id: 'new_group_name', class: 'text' %>
    <em class="info" style="font-size: 11px; color: #666;">GitLab group path will be auto-generated from this name</em>
  </p>

  <p id="gitlab_project_field" style="display: none;" data-selected-project-id="<%= @selected_project_id %>">
    <label for="gitlab_project_id">GitLab Project</label>
    <%= select_tag 'gitlab_project_id',
        options_for_select([["Don't create", ''], ['‚ûï Create new project', 'new']]),
        id: 'gitlab_project_id' %>
    <em class="info" id="gitlab_project_notice" style="font-size: 11px; color: #666; display: block; margin-top: 5px;">
      Link to an existing GitLab project or create a new one
    </em>
  </p>

  <p>
    <%= check_box_tag 'gitlab_project_public', '1', false, id: 'gitlab_project_public' %>
    <label for="gitlab_project_public">Make GitLab project public</label>
  </p>
</fieldset>

<%= javascript_tag do %>
(function() {
  const parentDropdown = document.getElementById('project_parent_id');
  const groupDropdown = document.getElementById('gitlab_group_id');
  const noticeDiv = document.getElementById('gitlab_group_notice');
  const newGroupField = document.getElementById('new_group_name_field');
  const newGroupNameInput = document.getElementById('new_group_name');
  const projectNameInput = document.getElementById('project_name');
  const projectForm = document.querySelector('form#new_project, form[id^="edit_project"]');
  const gitlabProjectField = document.getElementById('gitlab_project_field');
  const gitlabProjectDropdown = document.getElementById('gitlab_project_id');

  if (!groupDropdown) return;

  let userSelectedGroup = false;
  let userEditedGroupName = false;

  // Form submission validation
  if (projectForm) {
    projectForm.addEventListener('submit', function(e) {
      const selectedGroup = groupDropdown.value;

      if (!selectedGroup || selectedGroup === '') {
        e.preventDefault();
        alert('Please select a GitLab Group or create a new one');
        groupDropdown.focus();
        return false;
      }

      if (selectedGroup === 'new' && (!newGroupNameInput.value || newGroupNameInput.value.trim() === '')) {
        e.preventDefault();
        alert('Please enter a name for the new GitLab group');
        newGroupNameInput.focus();
        return false;
      }
    });
  }

  // GitLab group name sanitization
  function sanitizeGroupName(name) {
    if (!name) return '';
    return name
      .trim()
      .replace(/[^a-zA-Z0-9\s._-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/[-._]{2,}/g, '-')
      .replace(/^[-._]+|[-._]+$/g, '');
  }

  // Auto-populate group name from project name
  if (projectNameInput && newGroupNameInput) {
    projectNameInput.addEventListener('input', function() {
      if (!userEditedGroupName && groupDropdown.value === 'new') {
        newGroupNameInput.value = sanitizeGroupName(this.value);
      }
    });

    newGroupNameInput.addEventListener('input', function() {
      userEditedGroupName = true;
    });
  }

  // Fetch orphan projects for selected group
  function fetchOrphanProjects(groupId) {
    if (!groupId || groupId === '' || groupId === 'new') {
      gitlabProjectField.style.display = 'none';
      return;
    }

    // Get currently selected project ID from data attribute to include in request
    const selectedProjectId = gitlabProjectField.getAttribute('data-selected-project-id');
    const url = '/gitlab_groups/' + groupId + '/orphan_projects' +
                (selectedProjectId && selectedProjectId !== '' && selectedProjectId !== 'null'
                  ? '?current_project_id=' + selectedProjectId
                  : '');

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (data.success && data.projects) {
          // Clear existing options
          gitlabProjectDropdown.innerHTML = '';

          // Add default options
          const dontCreateOption = document.createElement('option');
          dontCreateOption.value = '';
          dontCreateOption.text = "Don't create";
          gitlabProjectDropdown.add(dontCreateOption);

          const newOption = document.createElement('option');
          newOption.value = 'new';
          newOption.text = '‚ûï Create new project';
          gitlabProjectDropdown.add(newOption);

          // Add available projects (orphans + currently linked)
          data.projects.forEach(function(project) {
            const option = document.createElement('option');
            option.value = project.id;
            option.text = project.name + ' (' + project.path + ')';
            gitlabProjectDropdown.add(option);
          });

          // Restore previously selected project if it exists in the list
          if (selectedProjectId && selectedProjectId !== '' && selectedProjectId !== 'null') {
            gitlabProjectDropdown.value = selectedProjectId;
          }

          // Show the field
          gitlabProjectField.style.display = 'block';
        }
      })
      .catch(err => {
        console.error('Error fetching orphan projects:', err);
        gitlabProjectField.style.display = 'none';
      });
  }

  // Handle "Create new group" option
  groupDropdown.addEventListener('change', function() {
    userSelectedGroup = true;

    if (this.value === 'new') {
      newGroupField.style.display = 'block';
      gitlabProjectField.style.display = 'none';
      if (!userEditedGroupName && projectNameInput && projectNameInput.value) {
        newGroupNameInput.value = sanitizeGroupName(projectNameInput.value);
      }
    } else {
      newGroupField.style.display = 'none';
      userEditedGroupName = false;

      // Fetch orphan projects for this group
      fetchOrphanProjects(this.value);
    }
  });

  // Handle parent project change
  if (parentDropdown) {
    parentDropdown.addEventListener('change', function() {
      const parentId = this.value;
      if (!parentId) {
        groupDropdown.value = '';
        noticeDiv.innerHTML = '';
        return;
      }

      if (userSelectedGroup) {
        checkGroupConflict(parentId);
        return;
      }

      fetch('/gitlab_mappings/fetch_parent_group?project_id=' + parentId)
        .then(res => res.json())
        .then(data => {
          if (data.group_id) {
            groupDropdown.value = data.group_id;
            noticeDiv.innerHTML = '<span class="info">üìã Inherited from: ' + data.inherited_from + '</span>';
          } else {
            groupDropdown.value = '';
            noticeDiv.innerHTML = '';
          }
        })
        .catch(err => {
          console.error('Error fetching parent group:', err);
        });
    });
  }

  function checkGroupConflict(parentId) {
    const selectedGroupId = groupDropdown.value;
    if (selectedGroupId === 'new' || selectedGroupId === '') return;

    fetch('/gitlab_mappings/fetch_parent_group?project_id=' + parentId)
      .then(res => res.json())
      .then(data => {
        if (data.group_id && data.group_id != selectedGroupId) {
          noticeDiv.innerHTML = '<span class="warning">‚ö†Ô∏è Parent project uses different GitLab Group</span>';
        } else {
          noticeDiv.innerHTML = '';
        }
      })
      .catch(err => {
        console.error('Error checking group conflict:', err);
      });
  }

  // Initialize: fetch orphan projects if a group is already selected (edit mode)
  if (groupDropdown.value && groupDropdown.value !== '' && groupDropdown.value !== 'new') {
    fetchOrphanProjects(groupDropdown.value);
  }
})();
<% end %>

<style>
#gitlab_group_notice {
  margin-top: 8px;
  font-size: 12px;
}

#gitlab_group_notice .info {
  color: #4A90E2;
  font-style: italic;
}

#gitlab_group_notice .warning {
  color: #FF6B6B;
  font-weight: bold;
}
</style>
